{% load static %}
{# Removed <link> tags for fonts/icons - assume they are in base.html #}

<nav class="navbar navbar-expand-lg {% if is_auth_page or not user.is_authenticated %}navbar-light bg-light{% else %}navbar-dark bg-purple{% endif %}">

    <div class="container-fluid">
        <a class="navbar-brand" href="{% url 'home' %}">
            <div class="logo-container d-flex align-items-center">
                <img src="{% static 'images/logo1.jpg' %}" alt="FillMate Logo" height="40" class="me-2">
            </div>
        </a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNavbarContent" aria-controls="mainNavbarContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="mainNavbarContent">
             {# Hide left links on auth pages OR if not logged in #}
            <ul class="navbar-nav me-auto mb-2 mb-lg-0 {% if is_auth_page or not user.is_authenticated %}d-none d-lg-flex{% endif %}">
                 {% if user.is_authenticated and not is_auth_page %}
                    {# Show HOD/User links ONLY if logged in AND NOT on an auth page #}
                    {% if is_hod_user %}
                        {# HOD Links #}
                        <li class="nav-item"><a class="nav-link {% if request.resolver_match.url_name == 'hod_dashboard' %}active{% endif %}" href="{% url 'users:hod_dashboard' %}">HOD Dashboard</a></li>
                        <li class="nav-item"><a class="nav-link {% if request.resolver_match.url_name == 'upload_signature' %}active{% endif %}" href="{% url 'users:upload_signature' %}">Upload Signature</a></li>
                    {% else %}
                        {# Regular User Links #}
                        <li class="nav-item"><a class="nav-link {% if request.resolver_match.url_name == 'user_dashboard' %}active{% endif %}" href="{% url 'users:user_dashboard' %}">Dashboard</a></li>
                        <li class="nav-item"><a class="nav-link {% if request.resolver_match.view_name == 'documents:my_documents' %}active{% endif %}" href="{% url 'documents:my_documents' %}">My Documents</a></li>
                    {% endif %}
                {% endif %}
            </ul>

            {# Right links #}
            <ul class="navbar-nav ms-auto mb-2 mb-lg-0 align-items-center">
                <li class="nav-item">
                    <a class="nav-link {% if request.path == '/' %}active{% endif %}" href="{% url 'home' %}">Home</a>
                </li>

                {# --- CORRECTED LOGIC for Right-Side Auth/Anon links --- #}

                {% if is_auth_page %}
                    {# === On an Authentication Page (Login/Signup) === #}
                    {# Show Login ONLY if NOT on login page itself #}
                    {% if request.resolver_match.url_name != 'login_page' %}
                        <li class="nav-item"> <a class="nav-link" href="{% url 'users:login_page' %}">Login</a> </li>
                    {% endif %}

                    {# Show Signup ONLY if NOT on signup page itself #}
                    {% if request.resolver_match.url_name != 'signup' %}
                       <li class="nav-item ms-2"> <a href="{% url 'users:signup' %}"><button class="s-btn">Signup</button></a> </li>
                    {% endif %}

                {% elif user.is_authenticated %}
                    {# === On a Regular Page AND User is Logged In === #}
                    {# Show Notifications/Logout #}
                    <li class="nav-item dropdown notification-dropdown">
                         <a class="nav-link notification-trigger" href="#" id="navbarDropdownNotifications" role="button" data-bs-toggle="dropdown" aria-expanded="false" style="position: relative;">
                            <i class="bi bi-bell fs-5"></i>
                            {% if unread_count > 0 %}
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger notification-badge">
                                {{ unread_count }}<span class="visually-hidden">unread notifications</span>
                            </span>
                            {% endif %}
                        </a>
                        <div class="dropdown-menu dropdown-menu-end notification-dropdown-menu shadow border-0 mt-2" aria-labelledby="navbarDropdownNotifications">
                             {# ... Notification dropdown content ... #}
                             <div class="notification-header px-3 py-2 d-flex justify-content-between align-items-center border-bottom">
                                <h6 class="mb-0 fw-bold">Notifications</h6>
                                {# Use the unread_count from the context processor #}
                                {% if unread_count > 0 %}
                                  <span class="badge bg-primary rounded-pill">{{ unread_count }} New</span>
                                {% endif %}
                            </div>
                        
                            <div class="notification-content"> {# Wrapper for scrollable content #}
                                {# Loop through unread_notifications from the context processor #}
                                {% for notification in unread_notifications %}
                                    {# Link to mark as read and potentially redirect #}
                                    {# The 'notifications:mark_read' view handles the logic #}
                                    <a href="{% url 'notifications:mark_read' pk=notification.id %}"
                                       class="dropdown-item notification-item {% if not notification.is_read %}unread{% endif %} py-2 px-3 d-block">
                                        <div class="notification-message">
                                            <p class="mb-1 notification-text small {% if not notification.is_read %}fw-bold{% endif %}">
                                                 {{ notification.message|truncatechars:100 }}
                                            </p>
                                            <small class="text-muted notification-time">
                                                 {{ notification.created_at|timesince }} ago
                                                 {% if notification.sender %} - By: {{ notification.sender.username }}{% endif %}
                                            </small>
                                        </div>
                                    </a>
                                {% empty %}
                                    {# Message shown if unread_notifications is empty #}
                                    <div class="notification-empty px-3 py-4 text-center text-muted small">
                                        No new notifications
                                    </div>
                                {% endfor %}
                            </div>
                            <div class="notification-footer border-top text-center py-2">
                                {# Link to the dedicated page showing all notifications #}
                                <a href="{% url 'notifications:all-notifications' %}" class="text-primary small fw-bold">
                                   View all notifications
                                </a>
                            </div>
                        </div>
                    </li>
                    <li class="nav-item"> <a class="nav-link" href="#" id="logout-link">Logout ({{ user.username }})</a> </li>

                {% else %}
                    {# === On a Regular Page AND User is Anonymous === #}
                    {# Show Login/Signup #}
                    <li class="nav-item"> <a class="nav-link" href="{% url 'users:login_page' %}">Login</a> </li>
                    <li class="nav-item ms-2"> <a href="{% url 'users:signup_page' %}"><button class="s-btn">Signup</button></a> </li>

                {% endif %}
                {# --- END CORRECTED LOGIC --- #}
            </ul>
        </div>
    </div>
</nav>

<!-- REMOVED <style> block -->

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const logoutLink = document.getElementById('logout-link');
            if (logoutLink) {
                logoutLink.addEventListener('click', function(event) {
                    event.preventDefault(); // Prevent default link behavior
        
                    // Optional: Add a confirmation dialog
                     if (!confirm('Are you sure you want to log out?')) {
                        return;
                     }
        
                    const csrfToken = getCookie('csrftoken'); // Assumes getCookie function exists (it's in your base.html)
        
                    fetch("{% url 'users:logout' %}", { // Use the correct logout URL
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrfToken,
                            'Accept': 'application/json' // Indicate we expect JSON
                        },
                        // No body needed for this specific logout view
                    })
                    .then(response => {
                        if (!response.ok) {
                            // Handle potential server errors during logout
                            throw new Error(`Logout failed (Status: ${response.status})`);
                        }
                        return response.json(); // Parse the JSON response from the backend
                    })
                    .then(data => {
                        if (data.success && data.redirect_url) {
                             // Clear any frontend tokens/user info upon successful logout
                            localStorage.removeItem('access_token');
                            localStorage.removeItem('refresh_token');
                            localStorage.removeItem('user_info');
                             // Redirect the user using the URL from the JSON response
                            window.location.href = data.redirect_url;
                        } else {
                             // Handle cases where JSON might be malformed or missing data
                            throw new Error('Logout response invalid.');
                        }
                    })
                    .catch(error => {
                        console.error('Logout Error:', error);
                        // Inform the user if logout failed unexpectedly
                        alert('Logout failed. Please try again or refresh the page.\nError: ' + error.message);
                    });
                });
            }
        });
        
        // Ensure getCookie function is available (it should be if base.html loads first)
        // function getCookie(name) { ... } // Already in your base.html
        </script>
        {# --- END SCRIPT --- #}