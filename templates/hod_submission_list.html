{% extends 'base.html' %}
{% load static %}

{% block title %}{{ page_title|default:"Submissions" }} | FillMate{% endblock %}

{# Link dashboard specific CSS for table styles #}
{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
    {# modals.css might be needed if you reuse the review modal directly, #}
    {# but linking to review page might be simpler here #}
{% endblock %}

{% block content %}
<section class="dashboard-content-actual">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 style="color: #692AA9;">{{ page_title }}</h1>
        <a href="{% url 'users:hod_dashboard' %}" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Main Dashboard
        </a>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-body p-0"> {# Remove padding if table has its own #}
            <div class="table-responsive">
                <table class="doc-table mb-0"> {# Use doc-table class, remove bottom margin #}
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Template</th>
                            <th>Submitted By</th>
                            <th>Date</th>
                            {% if status != 'Pending' %} {# Only show status column if not filtering by Pending #}
                                <th>Status</th>
                            {% endif %}
                             {% if status == 'Rejected' %}
                                <th>Reason</th> {# Show reason for rejected #}
                            {% endif %}
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for submission in submissions %}
                        <tr>
                            <td>#{{ submission.id }}</td>
                            <td>{{ submission.template.name }}</td>
                            <td>{{ submission.user.get_full_name|default:submission.user.username }}</td>
                            <td>{{ submission.submitted_at|date:"M d, Y" }}</td>

                            {% if status != 'Pending' %}
                            <td>
                                <span class="status-badge {% if submission.status == 'Approved' %}approved{% elif submission.status == 'Rejected' %}rejected{% else %}pending{% endif %}">
                                    {{ submission.status }}
                                </span>
                            </td>
                             {% endif %}

                             {% if status == 'Rejected' %}
                                <td class="small text-muted" title="{{ submission.rejection_reason|default:'' }}">
                                    {{ submission.rejection_reason|default:"N/A"|truncatechars:40 }}
                                </td>
                            {% endif %}

                            <td>
                                {# Actions based on the current filter status #}
                                {% if status == 'Pending' %}
                                    {# Option 1: Button to trigger existing review modal (Requires JS setup here too) #}
                                    <button class="btn btn-primary btn-sm btn-review" data-submission-id="{{ submission.id }}">
                                        <i class="bi bi-eye"></i> Review
                                    </button>
                                     {# Option 2: Link to a dedicated review page (if you build one) #}
                                     {# <a href="{% url 'documents:document-review-page' submission_id=submission.id %}" class="btn btn-primary btn-sm"> <i class="bi bi-eye"></i> Review </a> #}

                                {% elif status == 'Approved' %}
                                    {% if submission.approved_version.signed_file %}
                                        <a href="{{ submission.approved_version.signed_file.url }}" class="btn btn-success btn-sm" download>
                                            <i class="bi bi-download"></i> Download Signed
                                        </a>
                                    {% else %}
                                        <span class="badge bg-light text-dark">File Error</span>
                                    {% endif %}
                                {% elif status == 'Rejected' %}
                                     {% if submission.document %}
                                        <a href="{{ submission.document.url }}" class="btn btn-secondary btn-sm" download>
                                             <i class="bi bi-download"></i> Download Original
                                         </a>
                                     {% endif %}
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            {# Adjust colspan based on visible columns #}
                            <td colspan="{% if status == 'Rejected' %}7{% elif status == 'Pending' %}5{% else %}6{% endif %}" class="text-center text-muted py-4">
                                No submissions found with status '{{ status }}'.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    {# Pagination Controls #}
    {% if is_paginated %}
    <nav aria-label="Page navigation" class="mt-4">
      <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
          <li class="page-item"><a class="page-link" href="?page=1">« First</a></li>
          <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a></li>
        {% else %}
           <li class="page-item disabled"><span class="page-link">« First</span></li>
           <li class="page-item disabled"><span class="page-link">Previous</span></li>
        {% endif %}

        <li class="page-item active" aria-current="page">
          <span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
        </li>

        {% if page_obj.has_next %}
          <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a></li>
          <li class="page-item"><a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">Last »</a></li>
        {% else %}
            <li class="page-item disabled"><span class="page-link">Next</span></li>
            <li class="page-item disabled"><span class="page-link">Last »</span></li>
        {% endif %}
      </ul>
    </nav>
    {% endif %}

</section>

{# --- Include the Review Modal Structure (same as hoddash.html) --- #}
{# This is needed if you use Option 1 for the 'Review' button action #}
<div class="modal fade" id="reviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header text-white sticky-top">
                <h5 class="modal-title">Document Review</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0 d-flex flex-column">
                <div id="pdfContainer"><iframe id="pdfViewer"></iframe></div>
            </div>
            <div class="modal-footer">
                <div class="container-fluid">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <div id="rejectionSection">
                                <label for="rejectionReason" class="form-label">Rejection Reason</label>
                                <textarea id="rejectionReason" class="form-control form-control-sm" rows="2" placeholder="Please provide a reason for rejection" required></textarea>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex justify-content-end gap-2">
                                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal"><i class="bi bi-x-circle"></i> Close</button>
                                <button type="button" class="btn btn-danger btn-sm" id="rejectBtn"><i class="bi bi-x-octagon"></i> Reject</button>
                                <button type="button" class="btn btn-success btn-sm" id="approveBtn"><i class="bi bi-check-circle"></i> Approve</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{# --- End Review Modal --- #}

{% endblock %}


{% block extra_js %}
{# Add the SAME Review Modal JavaScript from hoddash.html #}
{# This is needed if you use Option 1 for the 'Review' button action #}
<script>
    // Global variable to track current submission
    let currentSubmissionId = null;

    const reviewModalEl = document.getElementById('reviewModal');
    const reviewModal = new bootstrap.Modal(reviewModalEl); // Initialize modal instance once

    document.addEventListener('DOMContentLoaded', function() {
        // --- Attach event listeners ---
        // Ensure listeners are re-attached if content is loaded dynamically,
        // but for full page loads, this is fine.
        document.querySelectorAll('.btn-review').forEach(btn => {
            btn.addEventListener('click', function() {
                currentSubmissionId = this.dataset.submissionId;
                showPdfInModal(currentSubmissionId);
                reviewModal.show(); // Show the modal using the instance
            });
        });

        document.getElementById('approveBtn')?.addEventListener('click', () => {
            handleDocumentDecision('approve');
        });

        const rejectBtn = document.getElementById('rejectBtn');
        const rejectionSection = document.getElementById('rejectionSection');
        const rejectionField = document.getElementById('rejectionReason');

        rejectBtn?.addEventListener('click', () => {
            // Use classList.contains instead of style.display for toggling
            if (!rejectionSection.classList.contains('show')) {
                rejectionSection.classList.add('show'); // Show rejection reason
                rejectBtn.innerHTML = '<i class="bi bi-x-octagon"></i> Confirm Rejection';
                rejectionField.required = true; // Make textarea required
            } else {
                // Validate and submit rejection
                if (!rejectionField.value.trim()) {
                    alert('Please provide a reason for rejection');
                    rejectionField.focus(); // Focus the field
                    return;
                }
                handleDocumentDecision('reject');
            }
        });

         // Reset rejection state when modal is closed
        reviewModalEl.addEventListener('hidden.bs.modal', function () {
            rejectionSection.classList.remove('show');
            rejectBtn.innerHTML = '<i class="bi bi-x-octagon"></i> Reject';
            rejectionField.value = '';
            rejectionField.required = false;
            // Also reset approve button state
             const approveBtn = document.getElementById('approveBtn');
             if (approveBtn) {
                 approveBtn.disabled = false;
                 approveBtn.innerHTML = '<i class="bi bi-check-circle"></i> Approve';
             }
        });

    }); // End DOMContentLoaded

    // Function to display PDF in the modal
    function showPdfInModal(submissionId) {
        const pdfViewer = document.getElementById('pdfViewer');
        const modalTitle = reviewModalEl.querySelector('.modal-title');

        // Reset rejection UI
        document.getElementById('rejectionSection').classList.remove('show');
        document.getElementById('rejectionReason').value = '';
        document.getElementById('rejectBtn').innerHTML = '<i class="bi bi-x-octagon"></i> Reject';
        document.getElementById('rejectionReason').required = false;

        // Reset button states
        const approveBtn = document.getElementById('approveBtn');
        const rejectBtn = document.getElementById('rejectBtn');
        if (approveBtn) {
             approveBtn.disabled = false;
             approveBtn.innerHTML = '<i class="bi bi-check-circle"></i> Approve';
        }
         if (rejectBtn) rejectBtn.disabled = false;


        pdfViewer.src = 'about:blank';
        modalTitle.textContent = 'Loading Document...';

        // Assumes getActiveTokens is available globally from base.html
        getActiveTokens().then(tokens => {
            fetch(`/api/documents/submissions/${submissionId}/review/`, {
                 headers: { 'Authorization': `Bearer ${tokens.access}` }
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        let errorMsg = `Failed to load document (Status: ${response.status})`;
                        try { const data = JSON.parse(text); if (data.error) errorMsg = data.error; } catch(e) {}
                        throw new Error(errorMsg);
                    });
                }
                const disposition = response.headers.get('Content-Disposition');
                let filename = `Submission #${submissionId}`;
                if (disposition && disposition.includes('filename=')) {
                    filename = disposition.split('filename=')[1].split(';')[0].replace(/["']/g, '');
                }
                return response.blob().then(blob => ({ blob, filename }));
            })
            .then(({ blob, filename }) => {
                const url = URL.createObjectURL(blob);
                pdfViewer.src = url; // Set the source for the iframe
                modalTitle.textContent = `Review: ${filename}`;
            })
            .catch(error => {
                console.error('Error loading document for review:', error);
                modalTitle.textContent = 'Error Loading Document';
                pdfViewer.srcdoc = `<html style="height: 100%;"><body style="display: flex; justify-content: center; align-items: center; height: 100%; flex-direction: column; font-family: sans-serif; padding: 20px; box-sizing: border-box;"><div style="text-align: center; color: #dc3545;"><i class="bi bi-exclamation-triangle" style="font-size: 3rem;"></i><p style="margin-top: 1rem; font-size: 1.25rem; font-weight: 500;">Failed to load document</p><small style="color: #6c757d;">${error.message}</small></div></body></html>`;
            });
        }).catch(authError => {
             console.error("Authentication error:", authError);
             modalTitle.textContent = 'Authentication Error';
             pdfViewer.srcdoc = `<p style='text-align: center; padding: 20px;'>Could not authenticate to load document. Please log in again.</p>`;
        });
    }

    // Function to handle approve/reject decisions
    function handleDocumentDecision(action) {
        if (!currentSubmissionId) { return; }

        const data = { action };
        const rejectionField = document.getElementById('rejectionReason');

        if (action === 'reject') {
            const reason = rejectionField.value.trim();
            if (!reason) { alert('Please provide a rejection reason'); rejectionField.focus(); return; }
            data.reason = reason;
        }

        const approveBtn = document.getElementById('approveBtn');
        const rejectBtn = document.getElementById('rejectBtn');
        const activeBtn = action === 'approve' ? approveBtn : rejectBtn;
        const originalBtnText = activeBtn.innerHTML;

        approveBtn.disabled = true;
        rejectBtn.disabled = true;
        activeBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';

        // Assumes getActiveTokens and getCSRFToken are global
        getActiveTokens().then(tokens => {
            const csrfToken = getCSRFToken();
            fetch(`/api/documents/submissions/${currentSubmissionId}/review/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                    'Authorization': `Bearer ${tokens.access}`
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json().then(jsonData => ({ ok: response.ok, status: response.status, data: jsonData })) )
            .then(({ ok, status, data }) => {
                 if (!ok) { throw new Error(data.error || `Server responded with status ${status}`); }
                 return data;
            })
            .then(data => {
                alert(`Document successfully ${action === 'approve' ? 'approved' : 'rejected'}.`);
                reviewModal.hide();
                // Instead of location.reload(), maybe update UI dynamically if needed,
                // but reload is simpler for now.
                location.reload();
            })
            .catch(error => {
                console.error('Error handling document decision:', error);
                alert(`Action failed: ${error.message}`);
                activeBtn.innerHTML = originalBtnText; // Reset active button
                 // Re-enable both buttons on error
                 approveBtn.disabled = false;
                 rejectBtn.disabled = false;
            });
        }).catch(authError => {
             console.error("Authentication error:", authError);
             alert(`Authentication error: ${authError.message}. Please log in again.`);
             // Reset buttons
              if(approveBtn) approveBtn.disabled = false;
              if(rejectBtn) rejectBtn.disabled = false;
              if(activeBtn) activeBtn.innerHTML = originalBtnText;
        });
    }
</script>
{% endblock %}