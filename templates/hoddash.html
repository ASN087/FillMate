{% extends 'base.html' %} {# Now extends base to get navbar/sidebar #}
{% load static %}

{% block title %}HOD Dashboard | FillMate{% endblock %}

{# Link dashboard specific CSS #}
{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
    {# modals.css and notifications.css already linked in base.html #}
{% endblock %}


{% block content %}
{# Removed the outer <body class="dashboard-page"> tag #}
{# REMOVED the entire <nav class="navbar"> block defined here #}
{# REMOVED the entire <main class="dashboard-container"> and <aside class="sidebar"> blocks #}

{# Content Area starts here (within the main block provided by base.html) #}
<div class="container-fluid dashboard-content-actual">

    <h1 style="color: #692AA9; margin-bottom: 30px;">Welcome, HOD {{ request.user.username }}!</h1>

    {# Display Messages #}
     {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}

    <!-- Stats Cards with Icons -->
    {# Ensure these classes match dashboard.css #}
    <div class="stat-cards">
        <div class="stat-card">
            <div class="stat-icon" style="color: #FFC107;"> <i class="bi bi-hourglass"></i> </div>
            <h3>Pending Approvals</h3>
            <div class="value">{{ pending_count }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="color: #28A745;"> <i class="bi bi-check-circle"></i> </div>
            <h3>Approved Documents</h3>
            <div class="value">{{ approved_count }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="color: #DC3545;"> <i class="bi bi-x-circle"></i> </div>
            <h3>Rejected Documents</h3>
            <div class="value">{{ rejected_count }}</div>
        </div>
    </div>

    <!-- Document Table -->
    <h2 style="margin-bottom: 20px;">Recent Submissions</h2>
    <div class="table-responsive">
         {# Ensure table and status badge classes match dashboard.css #}
        <table class="doc-table">
            <thead>
                <tr>
                    <th>Submission ID</th>
                    <th>Template</th>
                    <th>Submitted By</th>
                    <th>Date</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for submission in recent_submissions %}
                <tr>
                    <td>#{{ submission.id }}</td>
                    <td>{{ submission.template.name }}</td>
                    <td>{{ submission.user.get_full_name|default:submission.user.username }}</td>
                    <td>{{ submission.submitted_at|date:"M d, Y" }}</td>
                    <td>
                        <span class="status-badge {% if submission.status == 'Approved' %}approved{% elif submission.status == 'Rejected' %}rejected{% else %}pending{% endif %}">
                            {{ submission.status }}
                        </span>
                    </td>
                    <td>
                        {# Use standard Bootstrap button classes #}
                        {% if submission.status == 'Pending' %}
                            <button class="btn btn-primary btn-sm btn-review" data-submission-id="{{ submission.id }}">
                                <i class="bi bi-eye"></i> Review
                            </button>
                        {% elif submission.status == 'Approved' and submission.approved_version.signed_file %}
                            <a href="{{ submission.approved_version.signed_file.url }}" class="btn btn-success btn-sm" download>
                                <i class="bi bi-download"></i> Download Signed
                            </a>
                        {% elif submission.document %}
                            <a href="{{ submission.document.url }}" class="btn btn-secondary btn-sm" download>
                                <i class="bi bi-download"></i> Download Original
                            </a>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr> <td colspan="6" style="text-align: center;">No recent submissions matching criteria</td> </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div> {# End container-fluid dashboard-content-actual #}


<!-- Review Modal -->
<div class="modal fade" id="reviewModal" tabindex="-1" aria-hidden="true"> {# Removed style="display: none;" #}
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content"> {# Removed inline height #}
            <div class="modal-header text-white sticky-top"> {# Removed bg-primary #}
                <h5 class="modal-title">Document Review</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body p-0 d-flex flex-column">
                <div id="pdfContainer">
                    <iframe id="pdfViewer"></iframe>
                </div>
            </div>

            {# Footer moved outside modal-body for correct fullscreen layout #}
             <div class="modal-footer"> {# Removed custom styles, use modal.css #}
                <div class="container-fluid">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            {# Added 'show' class control via JS #}
                            <div id="rejectionSection">
                                <label for="rejectionReason" class="form-label">Rejection Reason</label>
                                <textarea id="rejectionReason" class="form-control form-control-sm" rows="2" placeholder="Please provide a reason for rejection" required></textarea>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex justify-content-end gap-2">
                                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">
                                    <i class="bi bi-x-circle"></i> Close
                                </button>
                                <button type="button" class="btn btn-danger btn-sm" id="rejectBtn">
                                    <i class="bi bi-x-octagon"></i> Reject
                                </button>
                                <button type="button" class="btn btn-success btn-sm" id="approveBtn">
                                    <i class="bi bi-check-circle"></i> Approve
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}


{% block extra_js %}
{# Include Bootstrap JS if not in base.html, but it seems to be #}
{# <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script> #}
    <script>
        // Function to handle submission review
        function reviewSubmission(submissionId) {
            fetch(`/api/documents/submissions/${submissionId}/`)
                .then(response => response.json())
                .then(data => {
                    const modalBody = document.getElementById('reviewModalBody');
                    modalBody.innerHTML = `
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Document Details</h6>
                                <p><strong>Template:</strong> ${data.template.name}</p>
                                <p><strong>Submitted By:</strong> ${data.user.username}</p>
                                <p><strong>Date:</strong> ${new Date(data.created_at).toLocaleString()}</p>
                                <p><strong>Status:</strong> ${data.status}</p>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex justify-content-center">
                                    <iframe src="${data.document}" style="width: 100%; height: 400px; border: none;"></iframe>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    const reviewModal = new bootstrap.Modal(document.getElementById('reviewModal'));
                    reviewModal.show();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to load submission details');
                });
        }

        // Initialize Bootstrap dropdowns
        var dropdownElementList = [].slice.call(document.querySelectorAll('.dropdown-toggle'))
        var dropdownList = dropdownElementList.map(function (dropdownToggleEl) {
            return new bootstrap.Dropdown(dropdownToggleEl)
        });
    </script>
    <script>
        // Global variable to track current submission
// Clean, optimized review-related JavaScript
let currentSubmissionId = null;

const reviewModalEl = document.getElementById('reviewModal');
const reviewModal = new bootstrap.Modal(reviewModalEl); // Initialize modal instance once

document.addEventListener('DOMContentLoaded', function() {
        // --- Attach event listeners ---
        document.querySelectorAll('.btn-review').forEach(btn => {
            btn.addEventListener('click', function() {
                currentSubmissionId = this.dataset.submissionId;
                showPdfInModal(currentSubmissionId);
                reviewModal.show(); // Show the modal using the instance
            });
        });

        document.getElementById('approveBtn')?.addEventListener('click', () => {
            handleDocumentDecision('approve');
        });

        const rejectBtn = document.getElementById('rejectBtn');
        const rejectionSection = document.getElementById('rejectionSection');
        const rejectionField = document.getElementById('rejectionReason');

        rejectBtn?.addEventListener('click', () => {
            // Use classList.contains instead of style.display for toggling
            if (!rejectionSection.classList.contains('show')) {
                rejectionSection.classList.add('show'); // Show rejection reason
                rejectBtn.innerHTML = '<i class="bi bi-x-octagon"></i> Confirm Rejection';
                rejectionField.required = true; // Make textarea required
            } else {
                // Validate and submit rejection
                if (!rejectionField.value.trim()) {
                    alert('Please provide a reason for rejection');
                    rejectionField.focus(); // Focus the field
                    return;
                }
                handleDocumentDecision('reject');
            }
        });

         // Reset rejection state when modal is closed
        reviewModalEl.addEventListener('hidden.bs.modal', function () {
            rejectionSection.classList.remove('show');
            rejectBtn.innerHTML = '<i class="bi bi-x-octagon"></i> Reject';
            rejectionField.value = '';
            rejectionField.required = false;
            // Also reset approve button state if needed
             document.getElementById('approveBtn').disabled = false;
             document.getElementById('approveBtn').innerHTML = '<i class="bi bi-check-circle"></i> Approve';
        });

    }); // End DOMContentLoaded

// Function to display PDF in the modal
function showPdfInModal(submissionId) {
        const pdfViewer = document.getElementById('pdfViewer');
        const modalTitle = reviewModalEl.querySelector('.modal-title'); // Use modal element to find title

        // Reset rejection UI immediately (moved from DOMContentLoaded)
        document.getElementById('rejectionSection').classList.remove('show');
        document.getElementById('rejectionReason').value = '';
        document.getElementById('rejectBtn').innerHTML = '<i class="bi bi-x-octagon"></i> Reject';
        document.getElementById('rejectionReason').required = false;

        // Reset button states
        document.getElementById('approveBtn').disabled = false;
        document.getElementById('approveBtn').innerHTML = '<i class="bi bi-check-circle"></i> Approve';
        document.getElementById('rejectBtn').disabled = false;


        pdfViewer.src = 'about:blank'; // Clear previous PDF
        modalTitle.textContent = 'Loading Document...';

        // Use getActiveTokens from base.html if needed for auth
        getActiveTokens().then(tokens => {
            fetch(`/api/documents/submissions/${submissionId}/review/`, {
                 headers: {
                     'Authorization': `Bearer ${tokens.access}` // Add authorization if endpoint requires it
                 }
            })
            .then(response => {
                if (!response.ok) {
                     // Try to get error message from response body
                    return response.text().then(text => {
                        let errorMsg = `Failed to load document (Status: ${response.status})`;
                        try {
                            const data = JSON.parse(text);
                            if (data.error) errorMsg = data.error;
                        } catch(e) { /* Ignore parsing error, use default msg */ }
                        throw new Error(errorMsg);
                    });
                }
                // Get filename from Content-Disposition header if available
                const disposition = response.headers.get('Content-Disposition');
                let filename = `Submission #${submissionId}`;
                if (disposition && disposition.includes('filename=')) {
                    filename = disposition.split('filename=')[1].split(';')[0].replace(/["']/g, '');
                }
                return response.blob().then(blob => ({ blob, filename })); // Pass blob and filename
            })
            .then(({ blob, filename }) => {
                const url = URL.createObjectURL(blob);
                pdfViewer.onload = () => {
                    // Revoke previous URL to free memory, if applicable
                    // URL.revokeObjectURL(pdfViewer.dataset.previousUrl);
                    // pdfViewer.dataset.previousUrl = url;
                };
                pdfViewer.src = url;
                modalTitle.textContent = `Review: ${filename}`;
            })
            .catch(error => {
                console.error('Error loading document for review:', error);
                modalTitle.textContent = 'Error Loading Document';
                // Display error message within iframe for clarity
                pdfViewer.srcdoc = `
                    <html style="height: 100%;">
                        <body style="display: flex; justify-content: center; align-items: center; height: 100%; flex-direction: column; font-family: sans-serif; padding: 20px; box-sizing: border-box;">
                            <div style="text-align: center; color: #dc3545;">
                                <i class="bi bi-exclamation-triangle" style="font-size: 3rem;"></i>
                                <p style="margin-top: 1rem; font-size: 1.25rem; font-weight: 500;">Failed to load document</p>
                                <small style="color: #6c757d;">${error.message}</small>
                            </div>
                        </body>
                    </html>
                `;
            });
        }).catch(authError => {
             console.error("Authentication error:", authError);
             modalTitle.textContent = 'Authentication Error';
             pdfViewer.srcdoc = `<p style='text-align: center; padding: 20px;'>Could not authenticate to load document. Please log in again.</p>`;
             // Optionally force logout or redirect to login
        });
    }

// Function to handle approve/reject decisions
function handleDocumentDecision(action) {
        if (!currentSubmissionId) {
            console.error('No submission ID found');
            return;
        }

        const data = { action };
        const rejectionField = document.getElementById('rejectionReason');

        if (action === 'reject') {
            const reason = rejectionField.value.trim();
            if (!reason) {
                alert('Please provide a rejection reason');
                rejectionField.focus();
                return;
            }
            data.reason = reason;
        }

        const approveBtn = document.getElementById('approveBtn');
        const rejectBtn = document.getElementById('rejectBtn');
        const activeBtn = action === 'approve' ? approveBtn : rejectBtn;
        const originalBtnText = activeBtn.innerHTML;

        // Disable both buttons during processing
        approveBtn.disabled = true;
        rejectBtn.disabled = true;
        activeBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';

        getActiveTokens().then(tokens => {
            const csrfToken = getCSRFToken(); // Get CSRF from base.html function

            fetch(`/api/documents/submissions/${currentSubmissionId}/review/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                    'Authorization': `Bearer ${tokens.access}` // Add authorization
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                 // Try to parse JSON first to get potential error messages
                 return response.json().then(jsonData => {
                     if (!response.ok) {
                         throw new Error(jsonData.error || `Server responded with status ${response.status}`);
                     }
                     return jsonData; // Pass parsed data on success
                 }).catch(parseError => {
                     // If JSON parsing fails on error, throw a generic error
                     if (!response.ok) {
                          throw new Error(`Server responded with status ${response.status}`);
                     }
                     // If JSON parsing fails on success (unlikely), log and maybe proceed
                     console.error("JSON parsing error on successful response:", parseError);
                     return {}; // Return empty object or handle differently
                 });
            })
            .then(data => {
                // Success
                alert(`Document successfully ${action === 'approve' ? 'approved' : 'rejected'}.`); // Provide feedback
                reviewModal.hide(); // Close the modal
                location.reload(); // Refresh the dashboard to show updated status
            })
            .catch(error => {
                console.error('Error handling document decision:', error);
                alert(`Action failed: ${error.message}`);
                // Reset only the active button (or both if preferred)
                activeBtn.disabled = false;
                activeBtn.innerHTML = originalBtnText;
                // Re-enable the other button too
                 if (action === 'approve') rejectBtn.disabled = false; else approveBtn.disabled = false;

            });
        }).catch(authError => {
             console.error("Authentication error:", authError);
             alert(`Authentication error: ${authError.message}. Please log in again.`);
             // Reset buttons
             approveBtn.disabled = false;
             rejectBtn.disabled = false;
             activeBtn.innerHTML = originalBtnText;
        });
    }

    </script>
{% endblock %}

{# Include any additional JS files if needed #}

   
</body>
</html>