{% extends 'base.html' %}
{% load static %} {# Added load static #}

{% block title %}All Notifications | FillMate{% endblock %}

{# Link specific CSS #}
{% block extra_css %}
    {# notifications.css already linked in base.html #}
{% endblock %}


{% block content %}
<div class="container mt-4">
    <h2 class="mb-4" style="color: #692AA9;">All Notifications</h2>

    {# --- CORRECTED Conditional Back Button --- #}
    {% if user.is_authenticated %}
        {# ✅ Use the 'is_hod_user' context variable ✅ #}
        {% if is_hod_user %}
            {# If user is HOD, link back to HOD dashboard #}
            <a href="{% url 'users:hod_dashboard' %}" class="btn btn-outline-secondary mb-3">
                <i class="bi bi-arrow-left"></i> Back to HOD Dashboard
            </a>
        {% else %}
            {# If user is regular user, link back to user dashboard #}
             <a href="{% url 'users:user_dashboard' %}" class="btn btn-outline-secondary mb-3">
                 <i class="bi bi-arrow-left"></i> Back to Dashboard
            </a>
        {% endif %}
    {% endif %}
    {# --- End Corrected Conditional Back Button --- #}


    <div class="card shadow-sm border-0">
        <div class="card-body p-0">
            {% if notifications %}
            <ul class="list-group list-group-flush">
                {% for notification in notifications %}
                <li class="list-group-item notification-item {% if not notification.is_read %}unread{% endif %} p-3 d-flex justify-content-between align-items-start">
                    <div class="ms-2 me-auto">
                        <div class="{% if not notification.is_read %}fw-bold{% endif %}">{{ notification.message }}</div>
                        <small class="text-muted d-block">
                            {{ notification.created_at|date:"M d, Y, P" }}
                             {% if notification.sender %}
                                - From: {{ notification.sender.get_full_name|default:notification.sender.username }}
                             {% endif %}
                        </small>
                        {# Condition 1: Is it a SubmittedDocument notification AND the viewer is an HOD? #}
                        {% if notification.content_type.model == 'submitteddocument' and is_hod_user %}
                            {# ALWAYS render the button that triggers the review modal #}
                            <button type="button"
                                    class="btn btn-sm {% if not notification.is_read %}btn-primary{% else %}btn-outline-secondary{% endif %} p-0 mt-1 btn-review-notification"
                                    data-submission-id="{{ notification.object_id }}"
                                    data-notification-id="{{ notification.id }}"
                                    data-is-read="{{ notification.is_read|yesno:'true,false' }}">
                                <i class="bi bi-eye"></i> {% if not notification.is_read %}Review & Mark Read{% else %}Review{% endif %}
                            </button>
                
                        {# Condition 2: Is it some OTHER type of notification with a linked object AND NOT read? #}
                        {% elif notification.content_object and not notification.is_read %}
                             {# Render a link to mark read (assuming mark_read handles redirect) #}
                             {# If mark_read URL doesn't exist, this needs adjustment #}
                              {% if 'notifications:mark_read' %} {# Check if URL exists before rendering link #}
                                 <a href="{% url 'notifications:mark_read' pk=notification.id %}"
                                   class="btn btn-sm btn-link text-primary p-0 mt-1">
                                     Mark Read & View Details
                                 </a>
                              {% else %}
                                  <span class="text-muted small mt-1">(No action link)</span>
                              {% endif %}
                
                
                        {# Condition 3: Is it some OTHER type of notification with a linked object AND IS read? #}
                         {% elif notification.content_object and notification.is_read %}
                              {# Maybe link directly to the object if possible? #}
                              {% if notification.content_object.get_absolute_url %}
                                  <a href="{{ notification.content_object.get_absolute_url }}"
                                     class="btn btn-sm btn-link text-secondary p-0 mt-1">
                                      View Details
                                  </a>
                              {% else %}
                                   <span class="text-muted small mt-1">(Details viewed)</span>
                              {% endif %}
                
                        {# Condition 4: Is it a notification WITHOUT a linked object and NOT read? #}
                        {% elif not notification.content_object and not notification.is_read %}
                             {# Render a link to just mark as read (assuming mark_read exists) #}
                             {% if 'notifications:mark_read' %}
                                 <a href="{% url 'notifications:mark_read' pk=notification.id %}"
                                   class="btn btn-sm btn-link text-secondary p-0 mt-1">
                                     Mark as Read
                                 </a>
                             {% endif %}
                        {% endif %}
                        {# --- END FINAL REVISED ACTION --- #}
                
                    </div>
                     {% if not notification.is_read %}
                       <span class="badge bg-primary rounded-pill align-self-center">New</span>
                     {% else %}
                         <span class="badge bg-light text-secondary rounded-pill align-self-center">Read</span>
                     {% endif %}
                </li>
                {% empty %}
                <li class="list-group-item text-center text-muted p-4">
                    You have no notifications.
                </li>
                {% endfor %}
             </ul>
            {% else %}
             <div class="text-center text-muted p-4">No notifications found.</div> {# Fallback if list is empty #}
            {% endif %}
        </div>
    </div>

    {# Pagination #}
     {% if is_paginated %}
     <nav aria-label="Page navigation example" class="mt-4">
       <ul class="pagination justify-content-center">
         {% if page_obj.has_previous %}
           <li class="page-item"><a class="page-link" href="?page=1">« first</a></li>
           <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">previous</a></li>
         {% endif %}
         <li class="page-item disabled"><span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}.</span></li>
         {% if page_obj.has_next %}
           <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">next</a></li>
           <li class="page-item"><a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">last »</a></li>
         {% endif %}
       </ul>
     </nav>
     {% endif %}

</div>

{# ✅ --- ADD REVIEW MODAL HTML STRUCTURE --- ✅ #}
    <div class="modal fade" id="reviewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header text-white sticky-top">
                    <h5 class="modal-title">Document Review</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0 d-flex flex-column">
                    <div id="pdfContainer"><iframe id="pdfViewer"></iframe></div>
                </div>
                <div class="modal-footer">
                    <div class="container-fluid">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <div id="rejectionSection">
                                    <label for="rejectionReason" class="form-label">Rejection Reason</label>
                                    <textarea id="rejectionReason" class="form-control form-control-sm" rows="2" placeholder="Please provide a reason for rejection" required></textarea>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex justify-content-end gap-2">
                                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal"><i class="bi bi-x-circle"></i> Close</button>
                                    <button type="button" class="btn btn-danger btn-sm" id="rejectBtn"><i class="bi bi-x-octagon"></i> Reject</button>
                                    <button type="button" class="btn btn-success btn-sm" id="approveBtn"><i class="bi bi-check-circle"></i> Approve</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {# --- END REVIEW MODAL --- #}

{# Style block was removed intentionally #}
{% endblock %}

{% block extra_js %}
<script>
    // --- Review Modal & Notification Handling JavaScript ---

    // --- Global Variables ---
    let currentSubmissionId = null;
    const reviewModalEl = document.getElementById('reviewModal');
    // Initialize Bootstrap modal instance ONCE (if element exists)
    const reviewModal = reviewModalEl ? new bootstrap.Modal(reviewModalEl) : null;

    // --- Modal Functions (showPdfInModal, handleDocumentDecision) ---
    // (Make sure getActiveTokens and getCSRFToken are available globally from base.html)

    function showPdfInModal(submissionId) {
        // Ensure modal elements exist before manipulating them
        const pdfViewer = document.getElementById('pdfViewer');
        const modalTitle = reviewModalEl ? reviewModalEl.querySelector('.modal-title') : null;
        const rejectionSection = document.getElementById('rejectionSection');
        const rejectionField = document.getElementById('rejectionReason');
        const approveBtn = document.getElementById('approveBtn');
        const rejectBtn = document.getElementById('rejectBtn');

        // Reset UI elements safely
        if (rejectionSection) rejectionSection.classList.remove('show');
        if (rejectionField) { rejectionField.value = ''; rejectionField.required = false; }
        if (rejectBtn) rejectBtn.innerHTML = '<i class="bi bi-x-octagon"></i> Reject';
        if (approveBtn) { approveBtn.disabled = false; approveBtn.innerHTML = '<i class="bi bi-check-circle"></i> Approve'; }
        if (rejectBtn) rejectBtn.disabled = false;

        if (!pdfViewer || !modalTitle) {
            console.error("Modal elements not found for showing PDF.");
            return; // Exit if essential elements are missing
        }

        pdfViewer.src = 'about:blank';
        modalTitle.textContent = 'Loading Document...';

        getActiveTokens().then(tokens => {
            fetch(`/api/documents/submissions/${submissionId}/review/`, { headers: { 'Authorization': `Bearer ${tokens.access}` } })
            .then(response => { /* ... handle response, errors, blob ... */
                 if (!response.ok) throw new Error(`Failed to load document (Status: ${response.status})`);
                 const disposition = response.headers.get('Content-Disposition');
                 let filename = `Submission #${submissionId}`;
                 if (disposition && disposition.includes('filename=')) filename = disposition.split('filename=')[1].split(';')[0].replace(/["']/g, '');
                 return response.blob().then(blob => ({ blob, filename }));
            })
            .then(({ blob, filename }) => {
                const url = URL.createObjectURL(blob);
                pdfViewer.src = url;
                modalTitle.textContent = `Review: ${filename}`;
            })
            .catch(error => { /* ... handle fetch error ... */
                 console.error('Error loading document for review:', error);
                 modalTitle.textContent = 'Error Loading Document';
                 pdfViewer.srcdoc = `<html style="height: 100%;"><body style="display: flex; justify-content: center; align-items: center; height: 100%; flex-direction: column; font-family: sans-serif; padding: 20px; box-sizing: border-box;"><div style="text-align: center; color: #dc3545;"><i class="bi bi-exclamation-triangle" style="font-size: 3rem;"></i><p style="margin-top: 1rem; font-size: 1.25rem; font-weight: 500;">Failed to load document</p><small style="color: #6c757d;">${error.message}</small></div></body></html>`;
            });
        }).catch(authError => { /* ... handle auth error ... */ });
    }

    function handleDocumentDecision(action) {
         // --- Keep the existing handleDocumentDecision function code ---
         // --- It uses currentSubmissionId, calls fetch, handles response/error ---
         if (!currentSubmissionId) return;
         const data = { action };
         const rejectionField = document.getElementById('rejectionReason');
         if (action === 'reject') { /* ... get reason ... */ }
         const approveBtn = document.getElementById('approveBtn');
         const rejectBtn = document.getElementById('rejectBtn');
         const activeBtn = action === 'approve' ? approveBtn : rejectBtn;
         const originalBtnText = activeBtn.innerHTML;
         // Disable buttons, show spinner
         approveBtn.disabled = true; rejectBtn.disabled = true;
         activeBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Processing...';
         // Fetch API call
         getActiveTokens().then(tokens => {
             fetch(`/api/documents/submissions/${currentSubmissionId}/review/`, { /* ... POST request ... */ })
             .then( /* ... handle response ... */ )
             .then(data => { /* ... handle success ... */
                 alert(`Document successfully ${action === 'approve' ? 'approved' : 'rejected'}.`);
                 if (reviewModal) reviewModal.hide(); // Use modal instance
                 location.reload();
             })
             .catch(error => { /* ... handle error, reset buttons ... */
                 console.error('Error handling document decision:', error);
                 alert(`Action failed: ${error.message}`);
                 if(activeBtn) activeBtn.innerHTML = originalBtnText;
                 if(approveBtn) approveBtn.disabled = false;
                 if(rejectBtn) rejectBtn.disabled = false;
              });
         }).catch(authError => { /* ... handle auth error, reset buttons ... */ });
    }

    // --- Function to Mark Notification Read via API ---
    function markNotificationReadOnServer(notificationId, buttonElement) {
         // --- Keep the existing markNotificationReadOnServer function code ---
         // --- It calls fetch, updates UI on success ---
         const csrfToken = getCSRFToken();
         fetch(`/api/notifications/${notificationId}/read/`, { /* ... POST request ... */ })
         .then(response => response.json())
         .then(data => {
             if (data.status === 'success') { /* ... update UI ... */
                 const listItem = buttonElement.closest('.list-group-item');
                 if (listItem) {
                     listItem.classList.remove('unread');
                     listItem.querySelector('.fw-bold')?.classList.remove('fw-bold');
                     const statusBadge = listItem.querySelector('.badge.bg-primary');
                     if (statusBadge) { /* ... change badge ... */ }
                     buttonElement.innerHTML = '<i class="bi bi-eye"></i> Review'; // Update text
                     buttonElement.dataset.isRead = 'true';
                 }
             } else { /* ... log error ... */ }
         })
         .catch(error => { /* ... log error ... */ });
    }


    // --- SINGLE DOMContentLoaded Listener ---
    document.addEventListener('DOMContentLoaded', function() {

        // **Listener for Notification Review Buttons on THIS page**
        document.querySelectorAll('.btn-review-notification').forEach(btn => {
            btn.addEventListener('click', function() {
                const submissionId = this.dataset.submissionId;
                const notificationId = this.dataset.notificationId;
                const isRead = this.dataset.isRead === 'true';

                // Check if modal instance exists
                if (!reviewModal) {
                    console.error("Review modal instance not initialized.");
                    return;
                }

                currentSubmissionId = submissionId;
                showPdfInModal(submissionId);
                reviewModal.show();

                if (!isRead && notificationId) {
                    markNotificationReadOnServer(notificationId, this);
                }
            });
        });

         // **Listeners for Buttons INSIDE the Modal**
         const approveBtn = document.getElementById('approveBtn');
         const rejectBtn = document.getElementById('rejectBtn');
         const rejectionSection = document.getElementById('rejectionSection');
         const rejectionField = document.getElementById('rejectionReason');

         if (approveBtn) {
            approveBtn.addEventListener('click', () => handleDocumentDecision('approve'));
         }

         if (rejectBtn && rejectionSection && rejectionField) {
            rejectBtn.addEventListener('click', () => {
                if (!rejectionSection.classList.contains('show')) {
                    rejectionSection.classList.add('show');
                    rejectBtn.innerHTML = '<i class="bi bi-x-octagon"></i> Confirm Rejection';
                    rejectionField.required = true;
                } else {
                    if (!rejectionField.value.trim()) { alert('Please provide a reason'); rejectionField.focus(); return; }
                    handleDocumentDecision('reject');
                }
            });
         }

         // **Listener for Modal Closing**
         if (reviewModalEl) {
            reviewModalEl.addEventListener('hidden.bs.modal', function () {
                // Reset modal state
                if (rejectionSection) rejectionSection.classList.remove('show');
                if (rejectBtn) rejectBtn.innerHTML = '<i class="bi bi-x-octagon"></i> Reject';
                if (rejectionField) { rejectionField.value = ''; rejectionField.required = false; }
                if (approveBtn) { approveBtn.disabled = false; approveBtn.innerHTML = '<i class="bi bi-check-circle"></i> Approve'; }
                // Clear iframe src to stop loading/video etc.
                const pdfViewer = document.getElementById('pdfViewer');
                if (pdfViewer) pdfViewer.src = 'about:blank';
                currentSubmissionId = null; // Clear tracked submission ID
            });
         }

    }); // --- End SINGLE DOMContentLoaded ---

</script>
{% endblock %}